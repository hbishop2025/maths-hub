<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Maths Hub</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="assets/main.css"/>
</head>
<body class="bg-gray-100" data-page="explore">
<div class="flex h-screen">

  <!-- Sidebar (loaded via assets/sidebar-loader.js) -->
  <div id="sidebar"></div>

  <!-- Main -->
  <main class="flex-1 p-8 overflow-y-auto">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <div class="flex items-center">
        <button class="mr-4"><span class="material-icons">menu</span></button>
        <h1 class="text-2xl font-bold text-gray-800">Explore</h1>
      </div>
      <div class="flex items-center">
        <!-- ⬇️ Jump goes to the Info section -->
        <a class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center" href="#info">
          Go to Info <span class="material-icons ml-2">arrow_downward</span>
        </a>
      </div>
    </header>

    <!-- No-JS fallback -->
    <noscript>
      <div class="p-4 bg-yellow-50 text-yellow-800 rounded-lg mb-6">
        This site needs JavaScript to load the featured sites and information.
      </div>
    </noscript>

    <!-- Hero (editable via Decap: assets/data/explore_hero.json) -->
    <section>
      <div class="bg-white p-6 rounded-xl shadow-sm mb-10">
        <h2 id="explore-hero-headline" class="text-xl font-bold text-gray-800 mb-2">Loading…</h2>
        <p id="explore-hero-body" class="text-gray-600"></p>
      </div>
    </section>

    <!-- Featured Sites -->
    <section class="mt-10" id="featured">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Featured Sites</h2>
        <button id="featured-toggle" class="text-blue-500 font-semibold">View All</button>
      </div>
      <div id="featured-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      <p id="featured-empty" class="text-gray-500" hidden>No featured sites yet.</p>
    </section>

    <!-- Latest Information -->
    <section class="mt-10" id="info">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Latest Information</h2>
      </div>
      <div id="info-list" class="space-y-4"></div>
    </section>
  </main>
</div>

<!-- Shared scripts -->
<script src="assets/sidebar-loader.js"></script>
<script src="assets/cards.js"></script>

<script>
  // ---- Data sources ----
  const EXPLORE_HERO_JSON = "assets/data/explore_hero.json";
  const FEATURED_JSON     = "assets/data/featured_sites.json";
  const INFO_JSON         = "assets/data/info.json";

  // ---- Helpers ----
  const cacheOpt = { cache: "no-store" };

  async function getJSON(url){
    const r = await fetch(url, cacheOpt);
    return r.ok ? r.json() : null;
  }

  // Accept array or { items: [...] }
  function asItems(data, key = "items"){
    if (Array.isArray(data)) return data;
    if (data && Array.isArray(data[key])) return data[key];
    return [];
  }

  // Date helper (tolerates YYYY-MM-DD and ISO)
  function parseDateSafe(s){
    if (!s) return null;
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // ---- Hero ----
  (async function loadHero(){
    const d = await getJSON(EXPLORE_HERO_JSON);
    if (!d) return;
    // Support both {title, subtitle} and {headline, body}
    const title = d.title ?? d.headline ?? "Welcome to the Maths Hub!";
    const body  = d.subtitle ?? d.body ?? "";

    const h = document.getElementById("explore-hero-headline");
    const p = document.getElementById("explore-hero-body");
    if (h) h.textContent = title;
    if (p) p.textContent = body;
  })();

  // ---- Featured Sites ----
  let featuredAll = [];
  let showingAll  = false;

  async function loadFeatured(){
    const data  = await getJSON(FEATURED_JSON);
    const items = asItems(data).filter(s => s && s.active !== false);
    featuredAll = items;
    renderFeatured();

    const empty = document.getElementById("featured-empty");
    if (empty) empty.hidden = featuredAll.length > 0;
  }

  function renderFeatured(){
    const grid = document.getElementById("featured-grid");
    if (!grid) return;
    const max = showingAll ? 12 : 4;

    grid.innerHTML = "";
    featuredAll.slice(0, max).forEach(site => {
      // makeSiteCard is defined in assets/cards.js
      grid.appendChild(makeSiteCard(site));
    });

    const toggle = document.getElementById("featured-toggle");
    if (toggle) toggle.textContent = showingAll ? "Show Less" : "View All";
  }

  // ---- Latest Information ----
  async function loadInfo(){
    const data = await getJSON(INFO_JSON);
    const rows = asItems(data);

    // sort newest first; require at least text
    const sorted = rows
      .filter(r => r && r.text)
      .sort((a, b) => (parseDateSafe(b.date)?.getTime() || 0) - (parseDateSafe(a.date)?.getTime() || 0));

    const container = document.getElementById("info-list");
    if (!container) return;

    container.innerHTML = "";
    if (!sorted.length){
      container.innerHTML = '<p class="text-gray-500">No information yet.</p>';
      return;
    }
    sorted.forEach(r => container.appendChild(makeInfoCard(r)));
  }

  // ---- Init ----
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("featured-toggle");
    if (toggle){
      toggle.addEventListener("click", () => {
        showingAll = !showingAll;
        renderFeatured();
      });
    }
    loadFeatured().catch(e => console.error("Featured load error:", e));
    loadInfo().catch(e => console.error("Info load error:", e));
  });
</script>
</body>
</html>
