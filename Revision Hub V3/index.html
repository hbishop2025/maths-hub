<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <!-- Classic fallback for Google / Classroom -->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- PNG for general browsers and app previews -->
<link rel="icon" type="image/png" href="/favicon-32x32.png">

<!-- SVG for modern browsers -->
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <title>SJWMS Maths</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="assets/main.css"/>
</head>
<body class="bg-gray-100" data-page="explore">
  <div class="layout">  <!-- was: <div class="flex h-screen"> -->

    <!-- Sidebar -->
    <div id="sidebar" aria-label="Sidebar"></div>

    <!-- Main -->
    <main class="main p-6 overflow-y-auto"> <!-- was: class="flex-1 p-8 overflow-y-auto" -->
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold text-gray-800">Explore</h1>
      </div>
      <div class="flex items-center">
        <!-- ⬇️ Jump goes to the Info section -->
        <a class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center" href="#info">
          Go to Info <span class="material-icons ml-2">arrow_downward</span>
        </a>
      </div>
    </header>

    <!-- No-JS fallback -->
    <noscript>
      <div class="p-4 bg-yellow-50 text-yellow-800 rounded-lg mb-6">
        This site needs JavaScript to load the featured sites and information.
      </div>
    </noscript>

    <!-- Hero (editable via Decap: assets/data/explore_hero.json) -->
    <section>
      <div class="bg-white p-6 rounded-xl shadow-sm mb-10">
        <h2 id="explore-hero-headline" class="text-xl font-bold text-gray-800 mb-2">Loading…</h2>
        <p id="explore-hero-body" class="text-gray-600"></p>
      </div>
    </section>

    <!-- Featured Sites -->
    <section class="mt-10" id="featured">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Featured Sites</h2>
        <button id="featured-toggle" class="text-gray-800 font-semibold">View All</button>
      </div>
      <div id="featured-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      <p id="featured-empty" class="text-gray-500" hidden>No featured sites yet.</p>
    </section>

    <!-- Latest Information -->
    <section class="mt-10" id="info">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Latest Information</h2>
      </div>
      <div id="info-list" class="space-y-4"></div>
    </section>
  </main>
</div>

<!-- Shared scripts -->
<script src="assets/sidebar-loader.js"></script>
<script src="assets/cards.js"></script>

<script>
  // ---- Data sources ----
  const EXPLORE_HERO_JSON = "assets/data/explore_hero.json";
  const FEATURED_JSON     = "assets/data/featured_sites.json";
  const INFO_JSON         = "assets/data/info.json";

  const cacheOpt = { cache: "no-store" };

  async function getJSON(url){
    const res = await fetch(url, cacheOpt);
    if(!res.ok){
      console.error("Fetch failed:", url, res.status);
      return null;
    }
    return res.json();
  }
  function asItems(data){
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.items)) return data.items;
    return [];
  }
  function parseDateSafe(s){
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // ---- HERO ----
  (async()=>{
    try{
      const d = await getJSON(EXPLORE_HERO_JSON);
      if(!d) return;
      const title = d.title ?? d.headline ?? "Welcome to SJWMS Maths!";
      const body  = d.subtitle ?? d.body ?? "";
      const h = document.getElementById("explore-hero-headline");
      const p = document.getElementById("explore-hero-body");
      if(h) h.textContent = title;
      if(p) p.textContent = body;
    }catch(e){ console.error("Hero load error:", e); }
  })();

  // ---- FEATURED ----
  let featuredAll = [];
  let showingAll = false;

  async function loadFeatured(){
    try{
      const data  = await getJSON(FEATURED_JSON);
      const items = asItems(data).filter(s => s && s.active !== false);
      featuredAll = items;
      console.log("FEATURED items:", items);
      renderFeatured();
      const empty = document.getElementById("featured-empty");
      if (empty) empty.hidden = featuredAll.length > 0;
    }catch(e){ console.error("Featured load error:", e); }
  }
  function renderFeatured(){
    const grid = document.getElementById("featured-grid");
    if(!grid) return;
    const max = showingAll ? 12 : 4;
    grid.innerHTML = "";
    featuredAll.slice(0,max).forEach(site=>{
      if(typeof makeSiteCard === "function"){
        grid.appendChild(makeSiteCard(site));
      }else{
        // very simple fallback
        const div = document.createElement("div");
        div.className="bg-white p-4 rounded-xl shadow-sm";
        div.innerHTML = `<h3 class="font-semibold">${site.name||"Untitled"}</h3>
                         <p class="text-sm text-gray-600">${site.desc||""}</p>
                         ${site.url ? `<a class="text-blue-600 underline" href="${site.url}" target="_blank" rel="noopener">Open</a>` : ""}`;
        grid.appendChild(div);
      }
    });
    const toggle = document.getElementById("featured-toggle");
    if (toggle) toggle.textContent = showingAll ? "Show Less" : "View All";
  }

  // ---- INFO ----
  async function loadInfo(){
    try{
      const data = await getJSON(INFO_JSON);
      console.log("INFO raw JSON:", data);
      const rows = asItems(data);
      console.log("INFO normalized items:", rows);

      // Sort newest first if date present; keep items without date at the end
      rows.sort((a,b)=>{
        const da = parseDateSafe(a.date)?.getTime() ?? -Infinity;
        const db = parseDateSafe(b.date)?.getTime() ?? -Infinity;
        return db - da;
      });

      const container = document.getElementById("info-list");
      if(!container){
        console.warn("#info-list not found in DOM");
        return;
      }
      container.innerHTML = "";

      if(!rows.length){
        container.innerHTML = '<p class="text-gray-500">No information yet.</p>';
        return;
      }

      rows.forEach(r=>{
        if(typeof makeInfoCard === "function"){
          container.appendChild(makeInfoCard(r));
        }else{
          // Simple fallback if cards.js didn't load
          const div = document.createElement("div");
          div.className = "bg-white p-4 rounded-xl shadow-sm";
          div.innerHTML = `
            <p class="text-sm text-gray-500">${r.type||""}</p>
            <p class="font-semibold text-gray-800">${r.text||""}</p>
            ${r.date ? `<p class="text-sm text-gray-500">${r.date}</p>` : ""}
            ${r.url ? `<a class="inline-flex items-center mt-2 text-blue-600 underline" href="${r.url}" target="_blank" rel="noopener">More info</a>` : ""}
          `;
          container.appendChild(div);
        }
      });
    }catch(e){
      console.error("Info load error:", e);
      const container = document.getElementById("info-list");
      if(container){
        container.innerHTML = '<p class="text-red-600">Could not load information.</p>';
      }
    }
  }

  // ---- INIT ----
  document.addEventListener("DOMContentLoaded", ()=>{
    const toggle = document.getElementById("featured-toggle");
    if (toggle){
      toggle.addEventListener("click", ()=>{ showingAll = !showingAll; renderFeatured(); });
    }
    loadFeatured();
    loadInfo();
  });
</script>



  
<!-- First-visit modal -->
<div id="firstVisitOverlay" class="fixed inset-0 bg-black/50 z-[90] hidden"></div>

<div id="firstVisitModal"
     class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2
            w-[min(92vw,28rem)] rounded-2xl bg-white shadow-2xl z-[91] hidden
            border border-gray-200">
  <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
    <div class="flex items-center gap-2">
      <span class="inline-flex h-6 w-6 rounded-md items-center justify-center bg-yellow-400/90">
        <span class="material-icons text-gray-900 text-[18px]">construction</span>
      </span>
      <p class="font-semibold text-gray-800">SJWMS Maths</p>
    </div>
    <button id="fvClose"
            class="rounded-md border border-gray-200 bg-white px-2 py-1 text-gray-700 hover:bg-gray-50"
            aria-label="Close notice">
      <span class="material-icons text-[18px]">close</span>
    </button>
  </div>

  <div class="px-5 pt-4 pb-5">
    <h2 class="text-lg font-bold text-gray-900 mb-1">We’re still polishing things</h2>
    <p class="text-gray-700 text-sm">
      This site is under active construction. Some pages will change and a few links may move.
      Thanks for your patience — if something looks off, try again later or tell your teacher.
    </p>

    <div class="mt-4 flex items-center gap-3">
      <button id="fvGotIt"
              class="inline-flex items-center rounded-lg bg-yellow-400 text-gray-900 font-semibold px-3 py-2 hover:brightness-95">
        Got it
      </button>
      <button id="fvLater"
              class="text-sm text-gray-600 underline decoration-gray-300 hover:text-gray-800">
        Remind me later
      </button>
    </div>
  </div>
</div>
<script>
(function(){
  // Bump this to re-show after big updates (e.g. '1.0.0' -> '1.1.0')
  const NOTICE_VERSION = '1.0.0';
  const KEY = 'sjwms:firstVisitNotice';
  const OV = document.getElementById('firstVisitOverlay');
  const MD = document.getElementById('firstVisitModal');
  const btnClose = document.getElementById('fvClose');
  const btnGotIt = document.getElementById('fvGotIt');
  const btnLater = document.getElementById('fvLater');

  if(!OV || !MD) return;

  function openModal(){
    OV.classList.remove('hidden');
    MD.classList.remove('hidden');
    document.body.classList.add('overflow-hidden'); // prevent background scroll
    // focus the close for accessibility
    setTimeout(()=> btnGotIt?.focus(), 0);
  }
  function closeModal(permanent){
    OV.classList.add('hidden');
    MD.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    if(permanent) {
      try { localStorage.setItem(KEY, NOTICE_VERSION); } catch(e){}
    }
  }

  // Show only if the stored version differs
  let stored = null;
  try { stored = localStorage.getItem(KEY); } catch(e){}

  if(stored !== NOTICE_VERSION){
    // first visit or new version
    // delay a tick so it doesn't clash with your mobile menu animation
    setTimeout(openModal, 200);
  }

  // Handlers
  btnClose?.addEventListener('click', ()=> closeModal(true));
  btnGotIt?.addEventListener('click', ()=> closeModal(true));
  btnLater?.addEventListener('click', ()=> closeModal(false));
  OV.addEventListener('click', ()=> closeModal(false));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(false); });
})();
</script>

  
</body>
</html>
