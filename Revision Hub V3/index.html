<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Maths Hub</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="assets/main.css"/>
</head>
<body class="bg-gray-100" data-page="explore">
<div class="flex h-screen">

  <!-- Sidebar (loaded via assets/sidebar-loader.js) -->
  <div id="sidebar"></div>

  <!-- Main -->
  <main class="flex-1 p-8 overflow-y-auto">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <div class="flex items-center">
        <button class="mr-4"><span class="material-icons">menu</span></button>
        <h1 class="text-2xl font-bold text-gray-800">Explore</h1>
      </div>
      <div class="flex items-center">
        <!-- ⬇️ Jump goes to the Info section -->
        <a class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center" href="#info">
          Go to Info <span class="material-icons ml-2">arrow_downward</span>
        </a>
      </div>
    </header>

    <!-- No-JS fallback -->
    <noscript>
      <div class="p-4 bg-yellow-50 text-yellow-800 rounded-lg mb-6">
        This site needs JavaScript to load the featured sites and information.
      </div>
    </noscript>

    <!-- Hero (editable via Decap: assets/data/explore_hero.json) -->
    <section>
      <div class="bg-white p-6 rounded-xl shadow-sm mb-10">
        <h2 id="explore-hero-headline" class="text-xl font-bold text-gray-800 mb-2">Loading…</h2>
        <p id="explore-hero-body" class="text-gray-600"></p>
      </div>
    </section>

    <!-- Featured Sites -->
    <section class="mt-10" id="featured">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Featured Sites</h2>
        <button id="featured-toggle" class="text-blue-500 font-semibold">View All</button>
      </div>
      <div id="featured-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      <p id="featured-empty" class="text-gray-500" hidden>No featured sites yet.</p>
    </section>

    <!-- Latest Information -->
    <section class="mt-10" id="info">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Latest Information</h2>
      </div>
      <div id="info-list" class="space-y-4"></div>
    </section>
  </main>
</div>

<!-- Shared scripts -->
<script src="assets/sidebar-loader.js"></script>
<script src="assets/cards.js"></script>

<script>
  // Data sources
  const EXPLORE_HERO_JSON = "Revision Hub V3/assets/data/explore_hero.json";
  const FEATURED_JSON     = "Revision Hub V3/assets/data/featured_sites.json"; // Decap-managed
  const INFO_JSON         = "Revision Hub V3/assets/data/info.json";           // Decap-managed

  // ---- Hero ----
  fetch(EXPLORE_HERO_JSON, {cache:"no-store"})
    .then(r => r.json())
    .then(d => {
      document.getElementById("explore-hero-headline").textContent = d.headline || "Welcome to the Maths Hub!";
      document.getElementById("explore-hero-body").textContent = d.body || "";
    })
    .catch(()=>{ /* leave defaults */ });

  // Helper: tolerate array or {items:[]}
  function normalizeJsonArray(data){
    if (Array.isArray(data)) return data;
    if (data && Array.isArray(data.items)) return data.items;
    return [];
  }

  // ---- Featured Sites (uses makeSiteCard from assets/cards.js) ----
  let featuredAll = [];
  let showingAll  = false;

  async function loadFeatured(){
    const res  = await fetch(FEATURED_JSON, {cache:'no-store'});
    const data = await res.json();
    const items = normalizeJsonArray(data).filter(s => s && s.active !== false);

    featuredAll = items;
    renderFeatured();

    // Empty message toggle
    document.getElementById("featured-empty").hidden = (featuredAll.length > 0);
  }

  function renderFeatured(){
    const grid   = document.getElementById("featured-grid");
    const max    = showingAll ? 12 : 4;
    grid.innerHTML = '';
    (featuredAll.slice(0, max)).forEach(site => {
      // makeSiteCard should exist in assets/cards.js
      grid.appendChild(makeSiteCard(site));
    });
    const toggle = document.getElementById("featured-toggle");
    if (toggle){
      toggle.textContent = showingAll ? "Show Less" : "View All";
    }
  }

  // ---- Latest Info (uses makeInfoCard from assets/cards.js) ----
  function parseDate(s){
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  async function loadInfo(){
    const res  = await fetch(INFO_JSON, {cache:'no-store'});
    const data = await res.json();
    const now  = new Date();

    const items = normalizeJsonArray(data)
      .filter(r => r && r.text && r.date && parseDate(r.date) && parseDate(r.date) >= now)
      .sort((a,b)=> parseDate(a.date) - parseDate(b.date));

    const container = document.getElementById('info-list');
    container.innerHTML = '';
    if(!items.length){
      container.innerHTML = '<p class="text-gray-500">No upcoming information.</p>';
      return;
    }
    items.forEach(r => container.appendChild(makeInfoCard(r)));
  }

  // ---- Init ----
  document.addEventListener('DOMContentLoaded', ()=>{
    const toggle = document.getElementById('featured-toggle');
    if(toggle){
      toggle.addEventListener('click', ()=>{
        showingAll = !showingAll;
        renderFeatured();
      });
    }
    loadFeatured().catch(e=>console.error('Featured load error:', e));
    loadInfo().catch(e=>console.error('Info load error:', e));
  });
</script>
</body>
</html>
