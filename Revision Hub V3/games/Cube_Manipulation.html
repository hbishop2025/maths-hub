<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cube Builder 3D (Orbit Around Anchor)</title>
  <style>
    :root { --size: 48px; }
    html, body { height: 100%; }
    body { margin: 0; background: #f3f4f6; font-family: system-ui, sans-serif; overflow: hidden; }
    #ui {
      position: absolute; left: 12px; top: 12px; z-index: 20;
      background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12); font-size: 14px;
      display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
    }
    button, input { margin: 2px; }
    .mode { font-weight: 700; }

    #viewport { width: 100vw; height: 100vh; position: relative; perspective: 1200px; perspective-origin: 50% 50%; }

    #scene {
      position: absolute; left: 50%; top: 50%; transform-style: preserve-3d;
      transform-origin: 50% 50% 0;
      transform: translate3d(-50%, -50%, 0) rotateX(30deg) rotateY(35deg) translateZ(-700px);
      cursor: grab;
    }
    #scene.dragging { cursor: grabbing; }

    .cube { position: absolute; width: var(--size); height: var(--size); transform-style: preserve-3d; }
    .face { position: absolute; width: 100%; height: 100%; border: 1px solid rgba(0,0,0,0.08); box-sizing: border-box; opacity: 0.98; backface-visibility: hidden; }
    .f-front  { transform: rotateY(  0deg) translateZ(calc(var(--size)/2)); }
    .f-back   { transform: rotateY(180deg) translateZ(calc(var(--size)/2)); }
    .f-right  { transform: rotateY( 90deg) translateZ(calc(var(--size)/2)); }
    .f-left   { transform: rotateY(-90deg) translateZ(calc(var(--size)/2)); }
    .f-top    { transform: rotateX( 90deg) translateZ(calc(var(--size)/2)); }
    .f-bottom { transform: rotateX(-90deg) translateZ(calc(var(--size)/2)); }
    .shade-0 { filter: brightness(1); }
    .shade-1 { filter: brightness(0.9); }
    .shade-2 { filter: brightness(0.8); }
    .anchor .face { box-shadow: 0 0 8px rgba(34, 34, 255, 0.6) inset; }

    #grid { position: absolute; left: 50%; top: 50%; transform-style: preserve-3d; transform-origin: 50% 50% 0; transform: translate3d(-50%, -50%, 0) rotateX(90deg) translateZ(calc(-1 * var(--size)/2)); pointer-events: none; }
    .grid-dot { position: absolute; width: 4px; height: 4px; border-radius: 50%; background: #d1d5db; }

    #hud { position:absolute; right:12px; top:12px; z-index:20; font-size:12px; color:#111827; background: rgba(255,255,255,0.85); padding:6px 8px; border-radius:8px }
  </style>
</head>
<body>
  <div id="ui">
    <span class="mode" id="modeLabel">Mode: Add</span>
    <button id="addMode">Add Cube</button>
    <button id="removeMode">Remove Cube</button>
    <label>Color <input type="color" id="colorPicker" value="#ef4444"></label>
    <button id="reset">Reset</button>
    <button id="recenter">Recenter</button>
  </div>
  <div id="hud">W/A/S/D orbit · Q/E dolly zoom · Drag to orbit · Click faces to add/remove</div>

  <div id="viewport">
    <div id="scene"></div>
    <div id="grid"></div>
  </div>

  <script>
    const scene = document.getElementById('scene');
    const grid = document.getElementById('grid');
    const S = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--size'));

    let angleX = 30, angleY = 35;
    let distance = 700;

    const state = {
      cubes: new Map(),
      mode: 'add',
      color: '#ef4444',
      anchorKey: '0,0,0'
    };

    const modeLabel = document.getElementById('modeLabel');
    const setMode = (m) => { state.mode = m; modeLabel.textContent = `Mode: ${m[0].toUpperCase()+m.slice(1)}`; };
    document.getElementById('addMode').onclick = () => setMode('add');
    document.getElementById('removeMode').onclick = () => setMode('remove');
    document.getElementById('colorPicker').oninput = (e) => state.color = e.target.value;
    document.getElementById('reset').onclick = () => resetToAnchor();
    document.getElementById('recenter').onclick = () => { angleX = 30; angleY = 35; distance = 700; applyView(); };

    function applyView() {
      scene.style.transform = `translate3d(-50%, -50%, 0) rotateX(${angleX}deg) rotateY(${angleY}deg) translateZ(${-distance}px)`;
      grid.style.transform  = `translate3d(-50%, -50%, 0) rotateX(90deg) translateZ(${(-S/2)}px)`;
    }

    window.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      const orbitStep = 4;
      const dollyStep = 40;
      if (k === 'w') angleX = Math.max(-89, angleX - orbitStep);
      if (k === 's') angleX = Math.min(89, angleX + orbitStep);
      if (k === 'a') angleY -= orbitStep;
      if (k === 'd') angleY += orbitStep;
      if (k === 'q') distance = Math.max(150, distance - dollyStep);
      if (k === 'e') distance = Math.min(2000, distance + dollyStep);
      applyView();
    });

    // Mouse drag orbit
    let dragging = false, lastX = 0, lastY = 0;
    scene.addEventListener('mousedown', (e) => { dragging = true; lastX = e.clientX; lastY = e.clientY; scene.classList.add('dragging'); });
    window.addEventListener('mouseup', () => { dragging = false; scene.classList.remove('dragging'); });
    window.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const dx = e.clientX - lastX; const dy = e.clientY - lastY; lastX = e.clientX; lastY = e.clientY;
      angleY += dx * 0.4; angleX -= dy * 0.4;
      applyView();
    });

    window.addEventListener('wheel', (e) => {
      e.preventDefault();
      const factor = e.deltaY > 0 ? 1.1 : 0.9;
      distance = Math.max(150, Math.min(2000, distance * factor));
      applyView();
    }, { passive:false });

    function drawGrid(range=8) {
      grid.innerHTML = '';
      for (let x=-range; x<=range; x++) {
        for (let z=-range; z<=range; z++) {
          const dot = document.createElement('div');
          dot.className = 'grid-dot';
          dot.style.transform = `translate3d(${x*S}px, ${z*S}px, 0)`;
          grid.appendChild(dot);
        }
      }
    }

    const keyOf = (x,y,z) => `${x},${y},${z}`;

    function createCubeEl(color, isAnchor=false){
      const el = document.createElement('div');
      el.className = 'cube' + (isAnchor ? ' anchor' : '');
      const faces = [
        ['f-front',  '0,0,1',  'shade-0'],
        ['f-back',   '0,0,-1', 'shade-2'],
        ['f-right',  '1,0,0',  'shade-1'],
        ['f-left',   '-1,0,0', 'shade-1'],
        ['f-top',    '0,1,0',  'shade-0'],
        ['f-bottom', '0,-1,0', 'shade-2']
      ];
      for (const [cls, normal, shade] of faces){
        const f = document.createElement('div');
        f.className = `face ${cls} ${shade}`;
        f.style.background = color;
        f.dataset.normal = normal;
        el.appendChild(f);
      }
      return el;
    }

    function addCube(x,y,z,color,stateful=true,isAnchor=false){
      const k = keyOf(x,y,z);
      if (state.cubes.has(k)) return state.cubes.get(k);
      const el = createCubeEl(color, isAnchor);
      el.style.transform = `translate3d(${x*S}px, ${-y*S}px, ${z*S}px)`;
      el.dataset.pos = k;
      el.addEventListener('click', (e) => {
        const face = e.target.closest('.face');
        if (!face) return;
        const [nx,ny,nz] = face.dataset.normal.split(',').map(Number);
        if (state.mode === 'add') {
          addCube(x+nx, y+ny, z+nz, state.color);
        } else if (state.mode === 'remove') {
          if (el.classList.contains('anchor')) return;
          scene.removeChild(el);
          state.cubes.delete(k);
          e.stopPropagation();
        }
      });
      scene.appendChild(el);
      if (stateful) state.cubes.set(k, el);
      return el;
    }

    function resetToAnchor(){
      for (const [k, el] of state.cubes){ if (k !== state.anchorKey) { el.remove(); state.cubes.delete(k); } }
    }

    // Init
    drawGrid();
    addCube(0,0,0,'#808080', true, true);
    applyView();
  </script>
</body>
</html>
