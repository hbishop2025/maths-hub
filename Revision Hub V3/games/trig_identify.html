<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/svg" href="/assets/favicon.svg" />
  <title>SJWMS Maths — Trig Commander</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Shared layout / stripes / sidebar spacing -->
  <link rel="stylesheet" href="/assets/main.css"/>

  <style>
    :root{
      /* Trig Theme: Indigo */
      --accent:    #6366F1; /* indigo-500 */
      --accent-600:#4F46E5;
      --accent-dark:#4338CA;
    }
    body { font-family: 'Inter', sans-serif; }
    .material-icons { font-size: 24px; }
    html { scroll-behavior: smooth; }

    /* Graph Paper Background */
    body[data-page="game-template"] .bg-stripes{
      position: relative;
      background-color: #f8fafc;
      background-image: 
        linear-gradient(rgba(99, 102, 241, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* Game UI Elements */
    .ratio-btn {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    .ratio-btn:active {
        transform: scale(0.95);
    }
    .ratio-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Animations */
    @keyframes pulse-border {
        0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .highlight-pulse {
        animation: pulse-border 1.5s infinite;
    }

    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      background: #6366F1;
      animation: fall linear forwards;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(720deg); }
    }
  </style>
</head>

<body class="bg-gray-100"
      data-page="game-template">
  <div class="layout">
    <!-- Sidebar -->
    <div id="sidebar" aria-label="Sidebar"></div>

    <!-- Main content -->
    <main class="main p-8 overflow-y-auto">
      <!-- Top: back + title -->
      <header class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
          <a href="/index.html" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <span class="material-icons mr-1">arrow_back</span>
            Back to Maths Hub
          </a>
        </div>
      </header>

      <!-- Hero -->
      <section class="bg-white p-6 rounded-xl shadow-sm mb-6">
        <div class="flex items-start justify-between flex-wrap gap-4">
          <div>
            <p class="uppercase tracking-wide text-xs text-gray-500 mb-1">
              Trigonometry
            </p>
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800">
              Trig Commander
            </h1>
            <p class="text-gray-600 mt-2 max-w-2xl">
              Identify sides, select ratios, and solve for angles. Master the triangle to earn your rank.
            </p>
          </div>

          <div class="flex flex-col items-end gap-2 text-sm text-gray-500">
            <div class="flex items-center gap-1">
              <span class="material-icons text-base text-gray-400">stars</span>
              <span>Level: <span id="level-indicator" class="font-semibold text-indigo-600">Identify Sides</span></span>
            </div>
          </div>
        </div>
      </section>

      <!-- GAME AREA -->
      <section class="mt-6 grid grid-cols-1 lg:grid-cols-[minmax(0,3fr),minmax(0,2fr)] gap-6">
        
        <!-- Left: Canvas Game Board -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center relative overflow-hidden">
           <div class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur px-3 py-1 rounded-full border border-gray-200 text-sm font-bold text-gray-500 shadow-sm">
               Q<span id="q-num">1</span>
           </div>
           
           <div class="absolute top-4 right-4 z-10 flex gap-2">
               <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold border border-indigo-100 flex items-center gap-1">
                   <span class="material-icons text-sm">stars</span> <span id="score-display">0</span>
               </div>
           </div>

           <!-- The Canvas -->
           <canvas id="game-canvas" width="600" height="400" class="w-full h-auto max-h-[400px] bg-stripes rounded-lg cursor-crosshair mb-4 touch-none"></canvas>
           
           <!-- Controls (Dynamic) -->
           <div id="controls-area" class="w-full grid grid-cols-3 gap-3 md:gap-6 max-w-lg">
               <!-- Buttons injected by JS -->
           </div>
           
           <!-- Feedback Message -->
           <div id="feedback-msg" class="h-8 mt-4 text-center font-bold text-lg text-gray-800 transition-opacity opacity-0"></div>

           <!-- Effects Layer -->
           <div id="effects-layer" class="absolute inset-0 pointer-events-none z-0 overflow-hidden"></div>
        </div>

        <!-- Right: Helper / Instructions -->
        <div class="space-y-4">
          
          <!-- Mnemonic Card -->
          <div class="bg-indigo-900 text-white p-6 rounded-xl shadow-lg relative overflow-hidden group">
              <div class="absolute -right-6 -top-6 bg-white/10 w-24 h-24 rounded-full blur-xl group-hover:scale-150 transition-transform duration-700"></div>
              
              <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                  <span class="material-icons text-indigo-300">school</span> Memory Aid
              </h2>
              
              <div class="grid grid-cols-1 gap-4">
                  <div class="flex items-center gap-3">
                      <div class="bg-white/20 w-12 h-12 rounded-lg flex items-center justify-center font-black text-xl text-yellow-300">S</div>
                      <div class="text-sm text-indigo-100 leading-tight">
                          <strong class="text-white block">SOH</strong>
                          Sine = <span class="text-yellow-300">Opposite</span> / Hypotenuse
                      </div>
                  </div>
                  <div class="flex items-center gap-3">
                      <div class="bg-white/20 w-12 h-12 rounded-lg flex items-center justify-center font-black text-xl text-emerald-300">C</div>
                      <div class="text-sm text-indigo-100 leading-tight">
                          <strong class="text-white block">CAH</strong>
                          Cosine = <span class="text-emerald-300">Adjacent</span> / Hypotenuse
                      </div>
                  </div>
                  <div class="flex items-center gap-3">
                      <div class="bg-white/20 w-12 h-12 rounded-lg flex items-center justify-center font-black text-xl text-rose-300">T</div>
                      <div class="text-sm text-indigo-100 leading-tight">
                          <strong class="text-white block">TOA</strong>
                          Tangent = <span class="text-rose-300">Opposite</span> / Adjacent
                      </div>
                  </div>
              </div>
          </div>

          <!-- Instructions -->
          <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
              <span class="material-icons text-[20px] text-gray-500">info</span>
              Current Mission
            </h2>
            <div id="mission-text" class="text-sm text-gray-600 space-y-2">
                <!-- Updated by JS -->
            </div>
          </div>

        </div>
      </section>

      <div class="h-10"></div>
    </main>
  </div>

  <script src="/assets/sidebar-loader.js"></script>

  <!-- === GAME LOGIC === -->
  <script>
    // --- Global Game State ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-display');
    const qNumEl = document.getElementById('q-num');
    const feedbackEl = document.getElementById('feedback-msg');
    const controlsArea = document.getElementById('controls-area');
    const levelIndicator = document.getElementById('level-indicator');
    const missionText = document.getElementById('mission-text');
    
    let score = 0;
    let questionCount = 1;
    let currentTriangle = null;
    let isTransitioning = false;
    let currentMode = 'sides'; // 'sides', 'ratios', 'inverse'

    // --- Triangle Generator ---
    
    function generateTriangle() {
        // Determine Mode based on Question Number
        if (questionCount <= 5) currentMode = 'sides';
        else if (questionCount <= 10) currentMode = 'ratios';
        else currentMode = 'inverse';

        updateUIForMode();

        // 1. Define base triangle points
        const width = 120 + Math.random() * 80;
        const height = 120 + Math.random() * 80;
        
        // Vertices relative to local origin (0,0 is C)
        const pC = { x: 0, y: 0 };
        const pA = { x: 0, y: -height }; // Up
        const pB = { x: width, y: 0 };   // Right

        // 2. Choose Random Rotation
        const rotation = Math.random() * Math.PI * 2;
        
        // 3. Transform points to Canvas Center + Rotation
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        const transform = (p) => {
            const rx = p.x * Math.cos(rotation) - p.y * Math.sin(rotation);
            const ry = p.x * Math.sin(rotation) + p.y * Math.cos(rotation);
            return { x: centerX + rx, y: centerY + ry };
        };

        const A = transform(pA);
        const B = transform(pB);
        const C = transform(pC);

        // 4. Choose Reference Angle (A or B)
        const refVertexName = Math.random() < 0.5 ? 'A' : 'B';
        const refVertex = refVertexName === 'A' ? A : B;

        // 5. Define Sides
        let sides = {
            hyp: { p1: A, p2: B, name: 'Hypotenuse', code:'hyp', label: '' },
            opp: { p1: refVertexName === 'A' ? C : C, p2: refVertexName === 'A' ? B : A, name: 'Opposite', code:'opp', label: '' },
            adj: { p1: refVertexName === 'A' ? A : B, p2: C, name: 'Adjacent', code:'adj', label: '' }
        };

        let correctAnswer = '';
        let targetRatio = '';

        // 6. Setup Question based on Mode
        
        if (currentMode === 'sides') {
            // Pick one side to highlight
            const target = ['hyp', 'opp', 'adj'][Math.floor(Math.random() * 3)];
            sides[target].highlight = true; // Pre-highlight for identification
            correctAnswer = sides[target].code; // 'hyp', 'opp', or 'adj'
        }
        else {
            // Ratios or Inverse
            // Force a balanced distribution
            const types = ['sin', 'cos', 'tan'];
            // Use question count to rotate types to ensure balance
            targetRatio = types[questionCount % 3]; 

            // Activate the correct sides for this ratio
            let activeSides = [];
            if(targetRatio === 'sin') activeSides = ['opp', 'hyp'];
            if(targetRatio === 'cos') activeSides = ['adj', 'hyp'];
            if(targetRatio === 'tan') activeSides = ['opp', 'adj'];

            // Set Labels
            if (currentMode === 'ratios') {
                // SOH CAH TOA
                // One gets a number, one gets 'x'
                sides[activeSides[0]].label = Math.floor(Math.random() * 20 + 5).toString();
                sides[activeSides[1]].label = "x";
                correctAnswer = targetRatio;
            } else {
                // Inverse Trig
                // Both get numbers, finding Angle
                sides[activeSides[0]].label = Math.floor(Math.random() * 10 + 5).toString();
                sides[activeSides[1]].label = Math.floor(Math.random() * 20 + 15).toString();
                correctAnswer = targetRatio; // checking for sin/cos/tan logic, UI will show inverse
            }
        }

        return {
            points: { A, B, C },
            refVertex: refVertex,
            sides: sides,
            correctAnswer: correctAnswer,
            rotation: rotation
        };
    }

    function updateUIForMode() {
        let buttonsHTML = '';
        let missionHTML = '';
        
        if (currentMode === 'sides') {
            levelIndicator.textContent = "Identify Sides";
            levelIndicator.className = "font-semibold text-pink-600";
            missionHTML = `
                <p>Look at the <span class="text-pink-600 font-bold">Highlighted Side</span>.</p>
                <p>Is it the Hypotenuse (longest), Opposite (facing angle), or Adjacent (next to angle)?</p>
            `;
            buttonsHTML = `
                <button class="ratio-btn group bg-white border-2 border-pink-100 hover:border-pink-500 hover:bg-pink-50 rounded-xl p-4 shadow-sm" onclick="checkAnswer('hyp')">
                   <span class="text-xl font-bold text-gray-800">Hypotenuse</span>
                </button>
                <button class="ratio-btn group bg-white border-2 border-pink-100 hover:border-pink-500 hover:bg-pink-50 rounded-xl p-4 shadow-sm" onclick="checkAnswer('opp')">
                   <span class="text-xl font-bold text-gray-800">Opposite</span>
                </button>
                <button class="ratio-btn group bg-white border-2 border-pink-100 hover:border-pink-500 hover:bg-pink-50 rounded-xl p-4 shadow-sm" onclick="checkAnswer('adj')">
                   <span class="text-xl font-bold text-gray-800">Adjacent</span>
                </button>
            `;
        } else if (currentMode === 'ratios') {
            levelIndicator.textContent = "Find Side (Ratios)";
            levelIndicator.className = "font-semibold text-indigo-600";
            missionHTML = `
                <p>We need to find side <span class="font-mono bg-gray-100 px-1">x</span>.</p>
                <p>Look at the two labelled sides. Which ratio connects them?</p>
            `;
            buttonsHTML = `
               <button class="ratio-btn group bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('sin')">
                   <span class="text-2xl font-black text-gray-800">SIN</span>
                   <span class="text-xs text-gray-400 font-mono">Opp / Hyp</span>
               </button>
               <button class="ratio-btn group bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('cos')">
                   <span class="text-2xl font-black text-gray-800">COS</span>
                   <span class="text-xs text-gray-400 font-mono">Adj / Hyp</span>
               </button>
               <button class="ratio-btn group bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('tan')">
                   <span class="text-2xl font-black text-gray-800">TAN</span>
                   <span class="text-xs text-gray-400 font-mono">Opp / Adj</span>
               </button>
            `;
        } else {
            levelIndicator.textContent = "Find Angle (Inverse)";
            levelIndicator.className = "font-semibold text-emerald-600";
            missionHTML = `
                <p>We need to find the angle <span class="font-serif italic">θ</span>.</p>
                <p>You have two sides. Pick the correct <strong>Inverse</strong> function.</p>
            `;
            buttonsHTML = `
               <button class="ratio-btn group bg-white border-2 border-emerald-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('sin')">
                   <span class="text-2xl font-black text-gray-800">SIN⁻¹</span>
                   <span class="text-xs text-gray-400 font-mono">Opp / Hyp</span>
               </button>
               <button class="ratio-btn group bg-white border-2 border-emerald-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('cos')">
                   <span class="text-2xl font-black text-gray-800">COS⁻¹</span>
                   <span class="text-xs text-gray-400 font-mono">Adj / Hyp</span>
               </button>
               <button class="ratio-btn group bg-white border-2 border-emerald-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl p-4 flex flex-col items-center gap-1 shadow-sm" onclick="checkAnswer('tan')">
                   <span class="text-2xl font-black text-gray-800">TAN⁻¹</span>
                   <span class="text-xs text-gray-400 font-mono">Opp / Adj</span>
               </button>
            `;
        }

        controlsArea.innerHTML = buttonsHTML;
        missionText.innerHTML = missionHTML;
    }

    // --- Drawing System ---

    function drawGame() {
        if (!currentTriangle) return;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const { A, B, C } = currentTriangle.points;
        const t = currentTriangle;

        ctx.lineWidth = 4;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';

        // 1. Draw Triangle Body
        ctx.beginPath();
        ctx.moveTo(A.x, A.y);
        ctx.lineTo(B.x, B.y);
        ctx.lineTo(C.x, C.y);
        ctx.closePath();
        ctx.strokeStyle = '#334155'; // Slate 700
        ctx.stroke();
        
        // 2. Draw Right Angle Symbol at C
        drawRightAngle(C, A, B, 20);

        // 3. Draw Angle Arc at Ref Vertex (Smart Anti-Reflex)
        drawAngleArc(t.refVertex, t.points.C, t.points.A === t.refVertex ? t.points.B : t.points.A);

        // 4. Draw Labels
        ctx.font = "bold 18px 'Inter', sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        Object.values(t.sides).forEach(side => {
            // Draw if it has text OR if it's highlighted (Phase 1)
            if(side.label || side.highlight) {
                drawLabelOnLine(side.p1, side.p2, side.label, side.highlight);
            }
        });
    }

    function drawAngleArc(center, p1, p2) {
        const angle1 = Math.atan2(p1.y - center.y, p1.x - center.x);
        const angle2 = Math.atan2(p2.y - center.y, p2.x - center.x);
        
        let diff = angle2 - angle1;
        // Normalize diff to -PI to +PI
        while (diff <= -Math.PI) diff += 2 * Math.PI;
        while (diff > Math.PI) diff -= 2 * Math.PI;
        
        // If the interior angle is "diff", we want to draw that arc.
        // ctx.arc draws clockwise by default? No, positive angle is clockwise on canvas (y down).
        // Actually simplest way: draw center->p1, center->p2 lines, compute small angle.
        // But to draw the arc visually we need the correct start/end and direction.
        
        const anticlockwise = diff < 0;
        
        ctx.beginPath();
        ctx.arc(center.x, center.y, 30, angle1, angle2, anticlockwise);
        ctx.strokeStyle = '#6366F1';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Theta symbol placement
        // Use average vector
        const midAngle = angle1 + diff / 2;
        const tx = center.x + Math.cos(midAngle) * 45;
        const ty = center.y + Math.sin(midAngle) * 45;
        
        ctx.fillStyle = '#6366F1';
        ctx.font = "italic bold 20px serif";
        ctx.fillText("θ", tx, ty);
    }

    function drawLabelOnLine(p1, p2, text, isHighlight) {
        // Midpoint
        const mx = (p1.x + p2.x) / 2;
        const my = (p1.y + p2.y) / 2;
        
        // Normal vector logic for offset
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const len = Math.sqrt(dx*dx + dy*dy);
        const nx = -dy / len;
        const ny = dx / len;
        
        // Center of triangle check
        const t = currentTriangle.points;
        const cx = (t.A.x + t.B.x + t.C.x) / 3;
        const cy = (t.A.y + t.B.y + t.C.y) / 3;
        
        const vcx = mx - cx;
        const vcy = my - cy;
        const dot = nx * vcx + ny * vcy;
        const dir = dot > 0 ? 1 : -1;

        const offset = 25;
        const lx = mx + nx * offset * dir;
        const ly = my + ny * offset * dir;

        // Draw Background Bubble
        // If text is empty (Phase 1 highlight only), draw '?'
        const displayTxt = text === '' ? '?' : text;

        const textWidth = ctx.measureText(displayTxt).width;
        
        ctx.save();
        ctx.beginPath();
        ctx.arc(lx, ly, Math.max(textWidth/2 + 8, 16), 0, Math.PI*2);
        
        const highlightColor = currentMode === 'sides' ? '#FBCFE8' : '#FCD34D'; // Pink in Ph1, Yellow in Ph2/3
        const highlightStroke = currentMode === 'sides' ? '#DB2777' : '#F59E0B';
        
        ctx.fillStyle = isHighlight ? highlightColor : 'white';
        if(isHighlight) {
            ctx.shadowColor = highlightStroke;
            ctx.shadowBlur = 15;
        } else {
            ctx.shadowColor = 'rgba(0,0,0,0.1)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetY = 2;
        }
        ctx.fill();
        ctx.strokeStyle = isHighlight ? highlightStroke : '#CBD5E1';
        ctx.lineWidth = isHighlight ? 3 : 1;
        ctx.stroke();

        ctx.fillStyle = isHighlight ? '#881337' : '#1E293B';
        ctx.fillText(displayTxt, lx, ly);
        ctx.restore();
    }

    function rightAngle(p, pTowards1, pTowards2, size) {
        const v1x = pTowards1.x - p.x;
        const v1y = pTowards1.y - p.y;
        const len1 = Math.sqrt(v1x*v1x + v1y*v1y);
        const u1x = v1x/len1 * size;
        const u1y = v1y/len1 * size;

        const v2x = pTowards2.x - p.x;
        const v2y = pTowards2.y - p.y;
        const len2 = Math.sqrt(v2x*v2x + v2y*v2y);
        const u2x = v2x/len2 * size;
        const u2y = v2y/len2 * size;

        const cx = p.x + u1x + u2x;
        const cy = p.y + u1y + u2y;

        ctx.beginPath();
        ctx.moveTo(p.x + u1x, p.y + u1y);
        ctx.lineTo(cx, cy);
        ctx.lineTo(p.x + u2x, p.y + u2y);
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    function drawRightAngle(C, A, B, size) {
        rightAngle(C, A, B, size);
    }

    // --- Interaction ---

    window.checkAnswer = function(userChoice) {
        if(isTransitioning) return;
        
        const isCorrect = userChoice === currentTriangle.correctAnswer;
        
        if (isCorrect) {
            score++;
            scoreEl.innerText = score;
            let successTxt = "Correct!";
            
            if(currentMode === 'sides') successTxt = `Correct! That is the ${currentTriangle.sides[userChoice].name}.`;
            else if(userChoice === 'sin') successTxt = "Correct! Sin = Opp / Hyp";
            else if(userChoice === 'cos') successTxt = "Correct! Cos = Adj / Hyp";
            else if(userChoice === 'tan') successTxt = "Correct! Tan = Opp / Adj";
            
            feedbackEl.innerText = successTxt;
            feedbackEl.className = "h-8 mt-4 text-center font-bold text-lg text-emerald-600 opacity-100 transition-all";
            
            // Highlight the relevant sides
            highlightSides(userChoice);
            spawnConfetti();
        } else {
            feedbackEl.innerText = "Not quite. Check the highlighted sides.";
            feedbackEl.className = "h-8 mt-4 text-center font-bold text-lg text-rose-600 opacity-100 transition-all";
            // Highlight the CORRECT sides/answer
            highlightSides(currentTriangle.correctAnswer);
        }

        isTransitioning = true;
        setTimeout(() => {
            isTransitioning = false;
            questionCount++;
            qNumEl.innerText = questionCount;
            feedbackEl.classList.remove('opacity-100');
            feedbackEl.classList.add('opacity-0');
            newTurn();
        }, 2500);
    };

    function highlightSides(code) {
        // Reset highlights
        Object.values(currentTriangle.sides).forEach(s => s.highlight = false);
        
        // Mode specific highlighting
        if(currentMode === 'sides') {
            // Highlight only the specific side
            currentTriangle.sides[code].highlight = true;
        } else {
            // Ratios / Inverse: Highlight pairs
            if(code === 'sin') {
                currentTriangle.sides.opp.highlight = true;
                currentTriangle.sides.hyp.highlight = true;
            }
            if(code === 'cos') {
                currentTriangle.sides.adj.highlight = true;
                currentTriangle.sides.hyp.highlight = true;
            }
            if(code === 'tan') {
                currentTriangle.sides.opp.highlight = true;
                currentTriangle.sides.adj.highlight = true;
            }
        }
        drawGame(); // Redraw
    }

    function newTurn() {
        currentTriangle = generateTriangle();
        drawGame();
    }
    
    function spawnConfetti() {
        const effects = document.getElementById('effects-layer');
        for (let i = 0; i < 30; i++) {
          const c = document.createElement("div");
          c.className = "confetti";
          c.style.left = 50 + (Math.random() * 40 - 20) + "%"; // center-ish
          c.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
          c.style.animationDuration = Math.random() * 1 + 0.5 + "s";
          c.style.top = "50%"; // start from middle
          effects.appendChild(c);
        }
        setTimeout(() => { effects.innerHTML = ''; }, 2000);
    }

    // Init
    newTurn();

  </script>
</body>
</html>
