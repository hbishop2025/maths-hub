<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KS3 EOY Revision</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="/assets/main.css"/>

  <style>
    :root{
      --accent:#7C4DFF;
      --accent-600:#6A3FE6;
      --accent-700:#5A35C8;
    }
    body { font-family: 'Inter', sans-serif; }
    .material-icons { font-size: 24px; }
    html { scroll-behavior: smooth; }

    /* Optional dark card helper */
    .dark-card { background:#0f162b; border:1px solid rgba(255,255,255,.08); }

    /* Small tag chip */
    .chip {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.3rem .6rem; border-radius:999px;
      background:#F3F4F6; color:#374151; font-weight:600; font-size:.8rem;
    }

    /* MathJax inline rendering (if you later add maths here) */
    mjx-container[display="false"]{ display:inline !important; vertical-align:-0.1em; margin:0 .05em; }
    mjx-container[display="true"] { display:block !important; text-align:center; margin:.5rem 0; }
  </style>
</head>
<body class="bg-gray-100" data-page="ks3_eoy">
  <div class="layout">
    <!-- Sidebar -->
    <div id="sidebar" aria-label="Sidebar"></div>

    <!-- Main -->
    <main class="main p-8 overflow-y-auto">
      <!-- Top: back -->
      <header class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
          <a href="/ks3_hub.html" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <span class="material-icons mr-1">arrow_back</span> Back to KS3 Hub
          </a>
        </div>
      </header>

      <!-- Split intro cards -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Left: light -->
        <article class="bg-white rounded-2xl shadow-sm p-6">
          <div class="flex items-start gap-4">
            <span class="material-icons text-5xl text-gray-800">tips_and_updates</span>
            <div>
              <p class="uppercase tracking-wide text-xs text-gray-500 mb-1">KS3 • End of year</p>
              <h2 class="text-xl font-bold text-gray-800 mb-1">How to use these sets</h2>
              <p class="text-gray-600">
                Tackle one mixed set at a time. Mark immediately, then use results to choose tomorrow’s focus.
              </p>
              <div class="mt-3 flex flex-wrap gap-2">
                <a href="#countdowns" class="inline-flex items-center px-3 py-1.5 rounded-lg bg-gray-100 text-gray-700">
                  See countdowns <span class="material-icons ml-1">hourglass_bottom</span>
                </a>
                <a href="#unit-resources" class="inline-flex items-center px-3 py-1.5 rounded-lg bg-gray-100 text-gray-700">
                  Browse resources <span class="material-icons ml-1">arrow_downward</span>
                </a>
              </div>
            </div>
          </div>
        </article>

        <!-- Right: dark -->
        <article class="rounded-2xl p-6 text-white" style="background:#1F2937">
          <div class="flex items-start gap-4">
            <span class="material-icons text-5xl text-white/90">task_alt</span>
            <div class="flex-1">
              <h2 class="text-xl font-bold mb-1">Steady beats perfect</h2>
              <p class="text-white/80 mb-3">
                Short daily sessions add up. Get one set done, then rest. You’ve got this.
              </p>
              <div class="flex flex-wrap gap-2">
                <a href="#daily-tasks" class="inline-flex items-center px-4 py-2 rounded-lg bg-white text-gray-900 font-semibold">
                  Daily tasks <span class="material-icons ml-2">arrow_forward</span>
                </a>
              </div>
            </div>
          </div>
        </article>
      </section>

      <!-- ===================== COUNTDOWNS ===================== -->
      <section id="countdowns" class="mb-10" aria-label="EOY Countdowns">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Countdown to EOY exams</h2>
        <p class="text-gray-600 mb-4">Each year has two papers. Times update automatically.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Y7 -->
          <article class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-start gap-3 mb-4">
              <span class="material-icons text-4xl text-blue-600">hourglass_bottom</span>
              <div>
                <h3 class="text-lg font-bold text-gray-800">Year 7</h3>
                <p class="text-sm text-gray-500">Two papers</p>
              </div>
            </div>
            <div class="space-y-4" id="y7-countdowns">
              <!-- injected: two rows -->
            </div>
          </article>

          <!-- Y8 -->
          <article class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-start gap-3 mb-4">
              <span class="material-icons text-4xl text-green-600">hourglass_bottom</span>
              <div>
                <h3 class="text-lg font-bold text-gray-800">Year 8</h3>
                <p class="text-sm text-gray-500">Two papers</p>
              </div>
            </div>
            <div class="space-y-4" id="y8-countdowns"></div>
          </article>

          <!-- Y9 -->
          <article class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-start gap-3 mb-4">
              <span class="material-icons text-4xl text-purple-600">hourglass_bottom</span>
              <div>
                <h3 class="text-lg font-bold text-gray-800">Year 9</h3>
                <p class="text-sm text-gray-500">Two papers</p>
              </div>
            </div>
            <div class="space-y-4" id="y9-countdowns"></div>
          </article>
        </div>
      </section>

      <!-- ===================== DAILY TASKS (COMING SOON) ===================== -->
      <section id="daily-tasks" class="mb-10" aria-label="Daily Tasks">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily tasks</h2>
        <p class="text-gray-600 mb-4">Short, focused prompts for each year group.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <article class="rounded-2xl p-6 bg-white shadow-sm">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-800">Year 7</h3>
              <span class="chip">Coming soon</span>
            </div>
            <p class="text-gray-600 mt-2">Daily mini tasks will appear here.</p>
          </article>

          <article class="rounded-2xl p-6 bg-white shadow-sm">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-800">Year 8</h3>
              <span class="chip">Coming soon</span>
            </div>
            <p class="text-gray-600 mt-2">Daily mini tasks will appear here.</p>
          </article>

          <article class="rounded-2xl p-6 bg-white shadow-sm">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-800">Year 9</h3>
              <span class="chip">Coming soon</span>
            </div>
            <p class="text-gray-600 mt-2">Daily mini tasks will appear here.</p>
          </article>
        </div>
      </section>

      <!-- ===================== RESOURCES ===================== -->
      <section class="mt-10" id="unit-resources">
        <h2 class="text-2xl font-bold text-gray-800 mb-8">KS3 — Mixed Resources</h2>

        <!-- Year 7 -->
        <section class="mb-10">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Year 7</h3>
          <div id="grid-y7" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Year 8 -->
        <section class="mb-10" id="videos">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Year 8</h3>
          <div id="grid-y8" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Year 9 -->
        <section class="mb-10">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Year 9</h3>
          <div id="grid-y9" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <p id="unit-empty" class="text-gray-500" hidden>No resources available yet. Please check back later.</p>
      </section>
    </main>
  </div>

  <!-- Shared scripts -->
  <script src="/assets/sidebar-loader.js"></script>
  <script src="/assets/cards.js"></script>

  <!-- Page JS -->
  <script>
    // --------- Config (CMS JSON endpoints) ----------
    const EOY_DATES_URL     = "/assets/data/ks3_eoy_dates.json";
    const EOY_RESOURCES_URL = "/assets/data/ks3_eoy_resources.json";

    // --------- Helpers ----------
    function normList(data){
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.items)) return data.items;
      return [];
    }
    function ensureHttps(u){ return /^https?:\/\//i.test(u) ? u : ("https://" + u); }

    function iconFor(url){
      const u=(url||"").toLowerCase();
      if(u.endsWith(".pdf")) return {icon:"picture_as_pdf", cta:"View"};
      if(u.includes("youtube")||u.includes("youtu.be")||u.includes("watch")) return {icon:"videocam", cta:"Watch Now"};
      if(u.includes("quiz")||u.includes("forms.gle")||u.includes("form")) return {icon:"quiz", cta:"Take Quiz"};
      return {icon:"description", cta:"Open"};
    }

    function makeResCard({ title, url }){
      const safeUrl = ensureHttps(url);
      const { icon, cta } = iconFor(url);
      const yt = (url||"").match(/(?:youtube\.com.*[?&]v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      const media = yt
        ? (() => {
            const id = yt[1];
            const img = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
            return `
              <div class="w-full h-32 rounded-lg mb-4 overflow-hidden relative">
                <img src="${img}" alt="Video thumbnail" class="w-full h-full object-cover">
                <span class="material-icons absolute inset-0 m-auto w-12 h-12 flex items-center justify-center rounded-full bg-white/80 text-gray-800">play_arrow</span>
              </div>`;
          })()
        : `
          <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center bg-stripes relative">
            <span class="material-icons text-4xl text-gray-600">${icon}</span>
          </div>`;

      const el = document.createElement("a");
      el.href = safeUrl; el.target = "_blank"; el.rel = "noopener";
      el.className = "block bg-white p-4 rounded-xl shadow-sm hover:shadow-md hover:-translate-y-0.5 transition transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300";
      el.innerHTML = `
        ${media}
        <h3 class="font-semibold text-gray-800 mb-2">${title || "Untitled"}</h3>
        <div class="flex items-center text-sm font-semibold" style="color:var(--accent);">
          ${cta}
          <span class="material-icons ml-1">${cta==='Watch Now'?'play_arrow':(cta==='Take Quiz'?'arrow_forward':'open_in_new')}</span>
        </div>
      `;
      return el;
    }

    // --------- COUNTDOWNS ----------
    const countdownTargets = {
      y7: document.getElementById("y7-countdowns"),
      y8: document.getElementById("y8-countdowns"),
      y9: document.getElementById("y9-countdowns"),
    };

    // Accept multiple CMS shapes:
    // {
    //   "year7":[{"label":"Paper 1","datetime":"2025-06-10T09:00:00+01:00"},{"label":"Paper 2","datetime":"..."}],
    //   "year8":{ "exams":[{...},{...}] },
    //   "items":[{"year":"y7","label":"Paper 1","datetime":"..."}, ...]
    // }
    function extractExams(data, key){
      if (Array.isArray(data[key])) return data[key];
      if (data[key] && Array.isArray(data[key].exams)) return data[key].exams;
      const items = normList(data).filter(x => (x.year||x.group||"").toLowerCase() === key);
      return items;
    }

    function formatDiff(ms){
      if (ms <= 0) return "Started / finished";
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${d}d ${h}h ${m}m ${sec}s`;
    }

    function makeCountdownRow({label, datetime}){
      const row = document.createElement("div");
      row.className = "flex items-center justify-between rounded-lg border border-gray-200 p-3";
      row.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="material-icons text-gray-600">schedule</span>
          <div>
            <div class="font-semibold text-gray-800">${label || "Exam"}</div>
            <div class="text-xs text-gray-500">${datetime ? new Date(datetime).toLocaleString() : ""}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-extrabold text-gray-800 text-lg" data-eta>--</div>
          <div class="text-xs text-gray-500">remaining</div>
        </div>
      `;
      const etaEl = row.querySelector("[data-eta]");
      const target = datetime ? new Date(datetime).getTime() : 0;

      function tick(){
        const now = Date.now();
        etaEl.textContent = formatDiff(target - now);
      }
      tick();
      // update each second; keep a reference if you want to clear later
      const iid = setInterval(tick, 1000);
      // stop when removed
      const obs = new MutationObserver(() => {
        if (!document.body.contains(row)) { clearInterval(iid); obs.disconnect(); }
      });
      obs.observe(document.body, {subtree:true, childList:true});
      return row;
    }

    async function loadCountdowns(){
      try{
        const data = await fetch(EOY_DATES_URL, {cache:"no-store"}).then(r=>r.json());
        ["y7","y8","y9"].forEach(key=>{
          const box = countdownTargets[key]; if (!box) return;
          box.innerHTML = "";
          const exams = (extractExams(data, key) || []).slice(0,2); // show two
          if (exams.length === 0) {
            box.innerHTML = `<p class="text-sm text-gray-500">Dates coming soon.</p>`;
          } else {
            exams.forEach(ex => box.appendChild(makeCountdownRow({
              label: ex.label || ex.name || ex.paper || "Exam",
              datetime: ex.datetime || ex.date || ex.iso
            })));
          }
        });
      }catch(e){
        console.error("EOY countdown load error", e);
        Object.values(countdownTargets).forEach(box=>{
          if (box) box.innerHTML = `<p class="text-sm text-gray-500">Countdown unavailable.</p>`;
        });
      }
    }

    // --------- RESOURCES ----------
    const GRID = {
      y7: document.getElementById("grid-y7"),
      y8: document.getElementById("grid-y8"),
      y9: document.getElementById("grid-y9"),
    };

    // Accept shapes:
    // { items:[{year:"y7", title, url}, ...] }
    // or { y7:[{title,url},...], y8:[...], y9:[...] }
    function extractYearResources(data, key){
      if (Array.isArray(data[key])) return data[key];
      const items = normList(data).filter(x => (x.year||x.group||"").toLowerCase() === key);
      return items;
    }

    async function loadResources(){
      try{
        const data = await fetch(EOY_RESOURCES_URL, {cache:"no-store"}).then(r=>r.json());
        let total = 0;
        ["y7","y8","y9"].forEach(key=>{
          const grid = GRID[key]; if (!grid) return;
          grid.innerHTML = "";
          const items = extractYearResources(data, key) || [];
          items.forEach(item=>{
            if (item && item.title && item.url) {
              grid.appendChild(makeResCard({title:item.title, url:item.url}));
              total++;
            }
          });
        });
        document.getElementById("unit-empty").hidden = total > 0;
      }catch(e){
        console.error("EOY resources load error", e);
        document.getElementById("unit-empty").hidden = false;
      }
    }

    // --------- Boot ---------
    document.addEventListener("DOMContentLoaded", () => {
      loadCountdowns();
      loadResources();
    });
  </script>
</body>
</html>
